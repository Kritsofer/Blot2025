
// Festivalprogram for alle dager
const festivalProgram = {
    "Onsdag": [
        {
            "tid": "14:30",
            "Valhalla": "Opening Blot",
            "Gildehallen": "",
            "Helheim": ""
        },
        {
            "tid": "17:00",
            "Valhalla": "Voluspa",
            "Gildehallen": "",
            "Helheim": ""
        },
        {
            "tid": "17:30",
            "Valhalla": "",
            "Gildehallen": "Johnny Hexx",
            "Helheim": ""
        },
        {
            "tid": "18:15",
            "Valhalla": "Tempel",
            "Gildehallen": "",
            "Helheim": ""
        },
        {
            "tid": "19:00",
            "Valhalla": "",
            "Gildehallen": "Kirkebrann",
            "Helheim": ""
        },
        {
            "tid": "19:45",
            "Valhalla": "Gaahls Wyrd",
            "Gildehallen": "",
            "Helheim": ""
        },
        {
            "tid": "21:00",
            "Valhalla": "",
            "Gildehallen": "Nabala Liminal",
            "Helheim": ""
        },
        {
            "tid": "22:00",
            "Valhalla": "Eivør",
            "Gildehallen": "",
            "Helheim": ""
        },
        {
            "tid": "23:15",
            "Valhalla": "",
            "Gildehallen": "Painkiller",
            "Helheim": ""
        }
    ],
    "Torsdag": [
        {
            "tid": "14:30",
            "Valhalla": "Vanvidd",
            "Gildehallen": "",
            "Helheim": ""
        },
        {
            "tid": "15:15",
            "Valhalla": "",
            "Gildehallen": "Vocals WS",
            "Helheim": ""
        },
        {
            "tid": "16:00",
            "Valhalla": "Hrafngrimr",
            "Gildehallen": "",
            "Helheim": ""
        },
        {
            "tid": "18:00",
            "Valhalla": "The 3rd and the Mortal",
            "Gildehallen": "",
            "Helheim": ""
        },
        {
            "tid": "19:00",
            "Valhalla": "",
            "Gildehallen": "Jordsjuk",
            "Helheim": ""
        },
        {
            "tid": "20:00",
            "Valhalla": "Oranssi Pazuzu",
            "Gildehallen": "",
            "Helheim": ""
        },
        {
            "tid": "21:00",
            "Valhalla": "",
            "Gildehallen": "Lili Refrain",
            "Helheim": ""
        },
        {
            "tid": "22:00",
            "Valhalla": "Hypocrisy",
            "Gildehallen": "",
            "Helheim": ""
        },
        {
            "tid": "23:00",
            "Valhalla": "",
            "Gildehallen": "Astralseid",
            "Helheim": ""
        }
    ],
    "Fredag": [
        {
            "tid": "14:45",
            "Valhalla": "Voluspa",
            "Gildehallen": "",
            "Helheim": ""
        },
        {
            "tid": "16:00",
            "Valhalla": "",
            "Gildehallen": "Iskald",
            "Helheim": ""
        },
        {
            "tid": "16:00",
            "Valhalla": "",
            "Gildehallen": "",
            "Helheim": "Stage Dolls"
        },
        {
            "tid": "16:45",
            "Valhalla": "Mio",
            "Gildehallen": "",
            "Helheim": ""
        },
        {
            "tid": "17:30",
            "Valhalla": "",
            "Gildehallen": "Sylvaine",
            "Helheim": "TNT"
        },
        {
            "tid": "18:30",
            "Valhalla": "Mork",
            "Gildehallen": "",
            "Helheim": ""
        },
        {
            "tid": "19:30",
            "Valhalla": "",
            "Gildehallen": "Sigh",
            "Helheim": "Faun"
        },
        {
            "tid": "20:30",
            "Valhalla": "Ensiferum",
            "Gildehallen": "",
            "Helheim": ""
        },
        {
            "tid": "21:45",
            "Valhalla": "",
            "Gildehallen": "",
            "Helheim": "Mayhem"
        },
        {
            "tid": "22:00",
            "Valhalla": "",
            "Gildehallen": "Brannos",
            "Helheim": ""
        },
        {
            "tid": "23:00",
            "Valhalla": "Folket Bortafor",
            "Gildehallen": "",
            "Helheim": ""
        }
    ],
    "Lørdag": [
        {
            "tid": "14:30",
            "Valhalla": "",
            "Gildehallen": "Congelatio",
            "Helheim": ""
        },
        {
            "tid": "15:15",
            "Valhalla": "Folket Bortafor",
            "Gildehallen": "",
            "Helheim": ""
        },
        {
            "tid": "16:00",
            "Valhalla": "",
            "Gildehallen": "Plaguebond",
            "Helheim": "Apocalypse Orchestra"
        },
        {
            "tid": "16:45",
            "Valhalla": "Svarttjern",
            "Gildehallen": "",
            "Helheim": ""
        },
        {
            "tid": "17:30",
            "Valhalla": "",
            "Gildehallen": "Sylvaine",
            "Helheim": "Sowulo"
        },
        {
            "tid": "17:45",
            "Valhalla": "",
            "Gildehallen": "Gudsforlatt",
            "Helheim": ""
        },
        {
            "tid": "18:30",
            "Valhalla": "Ruim",
            "Gildehallen": "",
            "Helheim": ""
        },
        {
            "tid": "19:30",
            "Valhalla": "",
            "Gildehallen": "",
            "Helheim": "Hällas"
        },
        {
            "tid": "19:45",
            "Valhalla": "",
            "Gildehallen": "Friggs Døtre",
            "Helheim": ""
        },
        {
            "tid": "20:30",
            "Valhalla": "Benediction",
            "Gildehallen": "",
            "Helheim": ""
        },
        {
            "tid": "21:30",
            "Valhalla": "",
            "Gildehallen": "Runahild",
            "Helheim": ""
        },
        {
            "tid": "21:40",
            "Valhalla": "",
            "Gildehallen": "",
            "Helheim": "Tsjuder"
        },
        {
            "tid": "23:00",
            "Valhalla": "Eihwar",
            "Gildehallen": "",
            "Helheim": ""
        }
    ]
};

const thresholdMinutes = 45; // Overlappgrense
const defaultDuration = 60; // Estimert konsertvarighet

function renderProgram(day) {
    const tbody = document.querySelector("#program tbody");
    tbody.innerHTML = "";

    const scenes = ["Valhalla", "Gildehallen", "Helheim"];
    const lastTimes = { Valhalla: null, Gildehallen: null, Helheim: null };

    festivalProgram[day].forEach(row => {
        const tr = document.createElement("tr");

        // Tid
        const tdTid = document.createElement("td");
        tdTid.textContent = row.tid;
        tr.appendChild(tdTid);

        // Sjekk hver scene
        scenes.forEach(scene => {
            const td = document.createElement("td");
            td.textContent = row[scene];

            if (row[scene]) {
                const currentTime = parseTime(row.tid);
                if (lastTimes[scene]) {
    // Beregn slutttid for forrige konsert
    const lastEnd = new Date(lastTimes[scene].getTime() + defaultDuration * 60000);

                    // Hvis denne konserten starter før forrige er ferdig → overlapp
                    if (currentTime < lastEnd) {
                        td.classList.add("overlap");

                    // Marker også forrige rad som overlapp
                            const prevRow = tbody.lastElementChild;
                                if (prevRow) {
                                    prevRow.children[scenes.indexOf(scene) + 1].classList.add("overlap");
                                }
                            }
                                        }                                       
    lastTimes[scene] = currentTime;
            }
            tr.appendChild(td);
        });

        tbody.appendChild(tr);
    });
}

//Funksjon for Gantt presentasjon av programmet
function renderGantt(day) {
    const container = document.getElementById("gantt");
    container.innerHTML = "";

    const scenes = ["Valhalla", "Gildehallen", "Helheim"];
    const concerts = festivalProgram[day];
    const startOfDay = parseTime("12:00"); // litt før første konsert
    const endOfDay = parseTime("01:00"); // litt etter siste konsert (natt)

    scenes.forEach(scene => {
        const row = document.createElement("div");
        row.classList.add("gantt-row");
        row.innerHTML = `<span class="scene-label">${scene}</span>`;

        concerts
            .filter(c => c[scene])
            .forEach(c => {
                const start = parseTime(c.tid);
                const end = new Date(start.getTime() + defaultDuration * 60000);
                const left = ((start - startOfDay) / (endOfDay - startOfDay)) * 100;
                const width = ((end - start) / (endOfDay - startOfDay)) * 100;

                const block = document.createElement("div");
                block.classList.add("gantt-block");
                block.style.left = left + "%";
                block.style.width = width + "%";
                block.textContent = c[scene];
                row.appendChild(block);
            });

        container.appendChild(row);
    });
}
// Hjelpefunksjoner
function parseTime(t) {
    const [h, m] = t.split(":").map(Number);
    return new Date(2000, 0, 1, h, m);
}

function minutesBetween(d1, d2) {
    return Math.abs((d2 - d1) / 60000);
}

// Dagvelger
function setupDaySelector() {
    const selector = document.getElementById("daySelector");
    Object.keys(festivalProgram).forEach(day => {
        const option = document.createElement("option");
        option.value = day;
        option.textContent = day;
        selector.appendChild(option);
    });

    selector.addEventListener("change", () => {
        renderProgram(selector.value);
        renderGantt(selectedDay);
    });

    // Start med første dag
    renderProgram(Object.keys(festivalProgram)[0]);
    renderGantt(Object.keys(festivalProgram)[0]);
}

document.addEventListener("DOMContentLoaded", setupDaySelector);
